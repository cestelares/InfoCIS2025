<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Meta tags para evitar el caché y asegurar que se muestren las actualizaciones -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Indicadores CIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .kpi-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .tab-button {
            transition: all 0.3s ease;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }
        .tab-button.active {
            background-color: #0d6efd;
            color: white;
            box-shadow: 0 4px 14px 0 rgba(13, 110, 253, 0.39);
        }
        .tab-button:not(.active) {
            background-color: #e9ecef;
            color: #495057;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 350px;
        }
        #map {
            height: 450px;
            width: 100%;
            border-radius: 1rem;
            z-index: 0;
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 md:p-6">

        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Idiomas SENATI</h1>
        </header>

        <!-- Navegación de Pestañas -->
        <nav class="flex justify-center mb-8">
            <div class="flex space-x-4 p-2 bg-white rounded-xl shadow-sm">
                <button id="btn-cis" class="tab-button active">CIS</button>
                <button id="btn-englishscore" class="tab-button">EnglishScore</button>
            </div>
        </nav>

        <main id="main-content">
            <!-- Contenido del Dashboard CIS -->
            <div id="cis-content">
                <p class="text-lg text-gray-500 text-center mb-6">Análisis interactivo de participantes y cursos.</p>
                <!-- Filtros -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-white rounded-xl shadow-md">
                    <div>
                        <label for="periodo" class="block text-sm font-medium text-gray-700 mb-1">Periodo</label>
                        <div id="periodo-filter" class="flex rounded-md shadow-sm">
                            <!-- Botones de periodo se generarán aquí -->
                        </div>
                    </div>
                    <div>
                        <label for="zonal" class="block text-sm font-medium text-gray-700 mb-1">Zonal</label>
                        <select id="zonal-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div>
                        <label for="campus" class="block text-sm font-medium text-gray-700 mb-1">Campus</label>
                        <select id="campus-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                </div>

                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">Total Participantes</h3>
                        <p id="total-participantes" class="text-5xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">Total Cursos</h3>
                        <p id="total-cursos" class="text-5xl font-bold text-teal-600">0</p>
                    </div>
                </div>

                <!-- Gráficos y Mapa -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-5 bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-center">Distribución Geográfica de Participantes</h3>
                        <div id="map"></div>
                    </div>
                    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-center">Participantes por Mes de Inicio</h3>
                        <div class="chart-container"><canvas id="monthly-chart"></canvas></div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-center">Distribución por Materia</h3>
                        <div class="chart-container"><canvas id="materia-chart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Contenido de EnglishScore -->
            <div id="englishscore-content" class="hidden">
                 <div class="bg-white rounded-2xl shadow-lg p-8 max-w-3xl mx-auto">
                    <h2 class="text-3xl font-bold text-center mb-6" style="color: #003f5c;">Fechas de Examen EnglishScore</h2>
                    <p class="text-center text-slate-600 mb-8">A continuación podrá verificar las fechas programadas para los próximos exámenes:</p>
                    
                    <ul class="space-y-4 text-lg text-slate-700 mb-8">
                        <li class="flex items-center p-4 bg-slate-50 rounded-lg">
                            <span class="font-bold w-32">Septiembre:</span>
                            <span>01/09 al 07/09 del 2025</span>
                        </li>
                        <li class="flex items-center p-4 bg-slate-50 rounded-lg">
                            <span class="font-bold w-32">Octubre:</span>
                            <span>06/10 al 12/10 del 2025</span>
                        </li>
                        <li class="flex items-center p-4 bg-slate-50 rounded-lg">
                            <span class="font-bold w-32">Noviembre:</span>
                            <span>03/11 al 09/11 del 2025</span>
                        </li>
                        <li class="flex items-center p-4 bg-slate-50 rounded-lg">
                            <span class="font-bold w-32">Diciembre:</span>
                            <span>01/12 al 07/12 del 2025</span>
                        </li>
                    </ul>

                    <div class="text-center">
                        <a href="https://form.jotform.com/IDIOMAS_SENATI/ACREDITACION-ENGLISHSCORE" target="_blank" rel="noopener noreferrer" class="inline-block bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-blue-700 transition-colors">
                            Formulario de registro - EnglishScore
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const csvData = `Estado,ZONAL,CAMPUS,PERIODO,INICIO,FIN,MATERIA,PARTICIPANTES
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-10-31,2022-11-18,INGL,20
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-11-04,2022-11-24,INGL,6
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-12-06,2022-12-29,INGL,11
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-11-30,2022-12-21,INGL,2
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-05-05,2022-05-26,INGL,17
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-06-07,2022-06-28,INGL,15
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-06-09,2022-06-30,INGL,18
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-07-12,2022-08-02,INGL,21
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-07-14,2022-08-04,INGL,19
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-08-16,2022-09-06,INGL,18
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-09-07,2022-09-28,INGL,25
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-09-20,2022-10-11,INGL,16
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-09-21,2022-10-12,INGL,22
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2022,2022-10-25,2022-11-15,INGL,20
Ejecucion,ZONAL PIURA-TUMBES,UCP PIURA-ZI,2022,2022-11-23,2022-12-21,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,UCP PIURA-ZI,2022,2022-02-09,2022-03-09,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,UCP PIURA-ZI,2022,2022-03-16,2022-04-13,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,UCP PIURA-ZI,2022,2022-05-04,2022-06-01,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,CFP SULLANA,2022,2022-06-08,2022-07-06,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,CFP PIURA,2022,2022-07-20,2022-08-17,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,CFP TALARA,2022,2022-08-31,2022-09-28,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,CFP TUMBES,2022,2022-10-05,2022-11-02,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,UCP PIURA-ZI,2022,2022-11-09,2022-12-07,INTE,25
Ejecucion,ZONAL LA LIBERTAD,UCP TRUJILLO ETI IDIOMAS,2022,2022-09-26,2022-10-21,INTE,27
Ejecucion,ZONAL LA LIBERTAD,CFP TRUJILLO,2022,2022-10-24,2022-11-21,IPET,29
Ejecucion,ZONAL LA LIBERTAD,UCP TRUJILLO ETI IDIOMAS,2022,2022-11-28,2022-12-23,INTE,30
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2022,2022-09-18,2022-10-16,INGL,26
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2022,2022-10-23,2022-11-20,INGL,27
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2022,2022-11-27,2022-12-25,INGL,25
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2022,2022-01-02,2022-01-30,SCOU,25
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2022,2022-02-06,2022-03-06,SCOU,25
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2022,2022-03-13,2022-04-10,INGL,26
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2022,2022-04-17,2022-05-15,INGL,25
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2022,2022-05-22,2022-06-19,IFCE,25
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2022,2022-06-26,2022-07-24,IFCE,25
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2022,2022-07-31,2022-08-28,INGL,27
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2022,2022-09-04,2022-10-02,INGL,28
Ejecucion,ZONAL ANCASH,CFP CHIMBOTE,2022,2022-05-10,2022-06-01,INJR,22
Ejecucion,ZONAL ANCASH,CFP HUARAZ,2022,2022-08-15,2022-09-05,INCH,18
Ejecucion,ZONAL CAJAMARCA-AMAZONAS-SAN MARTÍN,UCP CHACHAPOYAS,2022,2022-07-18,2022-08-08,CITU,25
Ejecucion,ZONAL CAJAMARCA-AMAZONAS-SAN MARTÍN,UCP JAEN,2022,2022-09-01,2022-09-22,CNIU,23
Ejecucion,ZONAL LORETO,CFP IQUITOS,2022,2022-10-03,2022-10-24,INGL,28
Ejecucion,ZONAL UCAYALI-HUÁNUCO,CFP PUCALLPA,2022,2022-11-07,2022-11-28,INTE,26
Ejecucion,ZONAL UCAYALI-HUÁNUCO,CFP HUANUCO,2022,2022-04-04,2022-04-25,IPET,21
Ejecucion,ZONAL ICA-AYACUCHO,CFP PISCO,2022,2022-02-21,2022-03-14,IFCE,24
Ejecucion,ZONAL ICA-AYACUCHO,CFP CHINCHA,2022,2022-03-21,2022-04-11,SCOU,22
Ejecucion,ZONAL ICA-AYACUCHO,CFP ICA,2022,2022-06-13,2022-07-04,INJR,20
Ejecucion,ZONAL ICA-AYACUCHO,CFP AYACUCHO,2022,2022-08-22,2022-09-12,INCH,19
Ejecucion,ZONAL AREQUIPA-PUNO,CFP AREQUIPA,2022,2022-05-16,2022-06-06,CITU,30
Ejecucion,ZONAL AREQUIPA-PUNO,CFP MOLLENDO,2022,2022-07-04,2022-07-25,CNIU,15
Ejecucion,ZONAL AREQUIPA-PUNO,CFP JULIACA,2022,2022-09-05,2022-09-26,INGL,25
Ejecucion,ZONAL AREQUIPA-PUNO,CFP PUNO,2022,2022-10-17,2022-11-07,INTE,22
Ejecucion,ZONAL MOQUEGUA-TACNA,CFP TACNA,2022,2022-06-20,2022-07-11,IPET,26
Ejecucion,ZONAL MOQUEGUA-TACNA,CFP ILO,2022,2022-08-01,2022-08-22,IFCE,18
Ejecucion,ZONAL MOQUEGUA-TACNA,UCP TACNA ETI-CIS,2022,2022-11-14,2022-12-05,SCOU,21
Ejecucion,ZONAL LIMA-CALLAO,IND-CENTRO DE IDIOMAS,2022,2022-02-07,2022-02-28,INJR,29
Ejecucion,ZONAL LIMA-CALLAO,CFP VILLA EL SALVADOR,2022,2022-03-07,2022-03-28,INCH,27
Ejecucion,ZONAL LIMA-CALLAO,CFP CALLAO - VENTANILLA,2022,2022-04-11,2022-05-02,CITU,25
Ejecucion,ZONAL LIMA-CALLAO,CFP CAÑETE,2022,2022-09-12,2022-10-03,CNIU,23
Ejecucion,ZONAL JUNIN-PASCO-HUANCAVELICA,CFP HUANCAYO,2022,2022-07-11,2022-08-01,INGL,24
Ejecucion,ZONAL JUNIN-PASCO-HUANCAVELICA,CFP HUANCAVELICA,2022,2022-08-08,2022-08-29,INTE,17
Ejecucion,ZONAL JUNIN-PASCO-HUANCAVELICA,CFP LA OROYA,2022,2022-10-10,2022-10-31,IPET,15
Ejecucion,ZONAL CUSCO-APURIMAC-MADRE DE DIOS,CFP CUSCO,2022,2022-06-06,2022-06-27,IFCE,28
Ejecucion,ZONAL LIMA CALLAO,CFP LUIS CACERES GRAZIANI,2025,2025-01-09,2025-01-29,INGL,24
Ejecucion,ZONAL LIMA CALLAO,CFP LUIS CACERES GRAZIANI,2025,2025-01-08,2025-01-28,INGL,20
Ejecucion,ZONAL LIMA CALLAO,CFP LUIS CACERES GRAZIANI,2025,2025-02-13,2025-03-05,INGL,18
Ejecucion,ZONAL LIMA CALLAO,CFP LUIS CACERES GRAZIANI,2025,2025-02-12,2025-03-04,INGL,14
Ejecucion,ZONAL LIMA CALLAO,CFP LUIS CACERES GRAZIANI,2025,2025-03-13,2025-04-02,INGL,20
Ejecucion,ZONAL LIMA CALLAO,CFP LUIS CACERES GRAZIANI,2025,2025-03-12,2025-04-01,INGL,20
Ejecucion,ZONAL LIMA CALLAO,CFP INDEPENDENCIA,2025,2025-04-10,2025-04-30,IPET,15
Ejecucion,ZONAL LIMA CALLAO,CFP LUIS CACERES GRAZIANI,2025,2025-04-09,2025-04-29,INGL,15
Ejecucion,ZONAL LIMA CALLAO,CFP VILLA EL SALVADOR,2025,2025-05-08,2025-05-28,IFCE,20
Ejecucion,ZONAL LIMA CALLAO,CFP LUIS CACERES GRAZIANI,2025,2025-05-07,2025-05-27,INGL,20
Ejecucion,ZONAL LIMA CALLAO,CFP CALLAO - VENTANILLA,2025,2025-06-05,2025-06-25,SCOU,15
Ejecucion,ZONAL LIMA CALLAO,CFP LUIS CACERES GRAZIANI,2025,2025-06-04,2025-06-24,INGL,15
Ejecucion,ZONAL LIMA CALLAO,CFP CAÑETE,2025,2025-07-03,2025-07-23,INJR,20
Ejecucion,ZONAL LIMA CALLAO,CFP LUIS CACERES GRAZIANI,2025,2025-07-02,2025-07-22,INGL,20
Ejecucion,ZONAL LAMBAYEQUE,UCP CHICLAYO CENTRO ETI-IDIOMA,2025,2025-01-23,2025-02-12,INGL,19
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2025,2025-01-24,2025-02-13,INGL,10
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2025,2025-02-24,2025-03-17,INGL,22
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2025,2025-03-03,2025-03-24,INGL,21
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2025,2025-03-27,2025-04-16,INGL,20
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2025,2025-04-21,2025-05-12,INGL,23
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2025,2025-05-15,2025-06-04,INGL,20
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2025,2025-06-09,2025-06-30,INGL,19
Ejecucion,ZONAL LAMBAYEQUE,CFP CHICLAYO,2025,2025-07-03,2025-07-23,INGL,21
Ejecucion,ZONAL PIURA-TUMBES,UCP PIURA-ZI,2025,2025-02-05,2025-03-05,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,CFP SULLANA,2025,2025-03-12,2025-04-09,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,CFP TUMBES,2025,2025-04-23,2025-05-21,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,CFP TALARA,2025,2025-05-28,2025-06-25,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,CFP PIURA,2025,2025-07-02,2025-07-30,INTE,25
Ejecucion,ZONAL PIURA-TUMBES,UCP PIURA-ZI,2025,2025-08-06,2025-09-03,INTE,0
Ejecucion,ZONAL LA LIBERTAD,UCP TRUJILLO ETI IDIOMAS,2025,2025-08-11,2025-09-05,INTE,30
Ejecucion,ZONAL LA LIBERTAD,CFP TRUJILLO,2025,2025-08-09,2025-09-06,INTE,30
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2025,2025-07-06,2025-08-03,INGL,26
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2025,2025-01-26,2025-03-02,INGL,25
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2025,2025-03-09,2025-04-06,INGL,26
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2025,2025-04-13,2025-05-11,INGL,25
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2025,2025-05-18,2025-06-15,INGL,25
Ejecucion,ZONAL VIRTUAL,CAMPUS VIRTUAL,2025,2025-06-22,2025-07-20,INGL,25
`;
        let fullData = [];
        let monthlyChart, materiaChart, map, markersLayer;
        
        const zonalCoordinates = {
            "ZONAL LAMBAYEQUE": [-6.77137, -79.84088],
            "ZONAL LA LIBERTAD": [-8.11599, -79.02998],
            "ZONAL ANCASH": [-9.5278, -77.5278],
            "ZONAL CAJAMARCA-AMAZONAS-SAN MARTÍN": [-7.16378, -78.50027],
            "ZONAL LORETO": [-3.74912, -73.25383],
            "ZONAL UCAYALI-HUÁNUCO": [-8.37915, -74.55383],
            "ZONAL ICA-AYACUCHO": [-14.06777, -75.72861],
            "ZONAL AREQUIPA-PUNO": [-16.40904, -71.53745],
            "ZONAL MOQUEGUA-TACNA": [-18.1963, -70.9356],
            "ZONAL LIMA-CALLAO": [-12.04637, -77.04279],
            "ZONAL PIURA-TUMBES": [-5.19449, -80.63282],
            "ZONAL JUNIN-PASCO-HUANCAVELICA": [-12.06513, -75.20486],
            "ZONAL CUSCO-APURIMAC-MADRE DE DIOS": [-13.53194, -71.96746]
        };

        const campusCoordinates = {
            "CFP CHICLAYO": [-6.77, -79.84],
            "CFP TRUJILLO": [-8.11, -79.03],
            "CFP CHIMBOTE": [-9.07, -78.59],
            "CFP HUARAZ": [-9.53, -77.53],
            "UCP CHACHAPOYAS": [-6.23, -77.87],
            "CFP IQUITOS": [-3.75, -73.25],
            "CFP PUCALLPA": [-8.38, -74.55],
            "CFP PISCO": [-13.71, -76.20],
            "CFP AREQUIPA": [-16.40, -71.54],
            "CFP TACNA": [-18.01, -70.25],
            "CFP LUIS CACERES GRAZIANI": [-12.04, -77.03],
            "IND-CENTRO DE IDIOMAS": [-12.06, -77.04],
            "CFP VILLA EL SALVADOR": [-12.21, -76.94],
            "CFP CALLAO - VENTANILLA": [-11.91, -77.12],
            "CFP CAÑETE": [-13.08, -76.38],
            "UCP MOYOBAMBA-MANT": [-6.03, -76.97],
            "UCP MOYOBAMBA-TARAPOTO": [-6.48, -76.37],
            "UCP CHICLAYO CENTRO ETI-IDIOMA": [-6.78, -79.85],
            "CFP TALARA": [-4.58, -81.27],
            "CFP SULLANA": [-4.90, -80.68],
            "CFP PIURA": [-5.19, -80.63],
            "CFP HUANUCO": [-9.93, -76.24],
            "CFP CERRO DE PASCO": [-10.68, -76.26],
            "CFP CHINCHA": [-13.46, -76.13],
            "CFP ICA": [-14.07, -75.73],
            "CFP AYACUCHO": [-13.16, -74.22],
            "CFP CUSCO": [-13.52, -71.98],
            "CFP ILO": [-17.64, -71.34],
            "CFP INDEPENDENCIA": [-11.99, -77.06],
            "UCP JAEN": [-5.70, -78.80],
            "UCP PIURA-ZI": [-5.20, -80.64],
            "CFP MOLLENDO": [-17.02, -72.01],
            "CFP JULIACA": [-15.49, -70.13],
            "CENTRO DE ESTUDIOS GENERALES": [-12.05, -77.05],
            "CFP HUANCAVELICA": [-12.78, -74.97],
            "CFP RIO NEGRO": [-11.16, -75.28],
            "CFP HUANCAYO": [-12.07, -75.20],
            "CFP LA OROYA": [-11.52, -75.90],
            "CFP SAN RAMON": [-11.12, -75.35],
            "CFP PUNO": [-15.84, -70.02],
            "UCP TACNA ETI-CIS": [-18.02, -70.26],
            "UCP TRUJILLO ETI IDIOMAS": [-8.12, -79.04],
        };

        function loadAndProcessData() {
            try {
                const rows = csvData.trim().split(/\r?\n/).slice(1);
                fullData = rows.map(row => {
                    const columns = row.split(',');
                    return {
                        estado: (columns[0] || '').trim(),
                        zonal: (columns[1] || '').trim(),
                        campus: (columns[2] || '').trim(),
                        periodo: parseInt(columns[3], 10),
                        inicio: (columns[4] || '').trim(),
                        fin: (columns[5] || '').trim(),
                        materia: (columns[6] || '').trim(),
                        participantes: parseInt(columns[7], 10) || 0
                    };
                }).filter(row => row.zonal && !isNaN(row.periodo) && row.inicio);
            } catch (error) {
                console.error("Error al procesar los datos:", error);
                document.querySelector('.container').innerHTML = `<div class="text-center p-8 bg-red-100 text-red-700 rounded-xl"><h3>Error al Procesar los Datos</h3><p>Ocurrió un problema al leer la información interna.</p></div>`;
            }
        }

        function populateFilters() {
            const periodos = [...new Set(fullData.map(item => item.periodo))].sort((a,b) => b-a);
            const periodoContainer = document.getElementById('periodo-filter');
            periodoContainer.innerHTML = '';
            periodos.forEach((periodo, index) => {
                const button = document.createElement('button');
                button.textContent = periodo;
                button.dataset.periodo = periodo;
                button.className = `px-4 py-2 text-sm font-medium border-t border-b border-gray-200 ${index === 0 ? 'rounded-l-md border-l' : ''} ${index === periodos.length - 1 ? 'rounded-r-md border-r' : 'border-l'}`;
                if (index === 0) button.classList.add('active');
                periodoContainer.appendChild(button);
            });
            
            updateZonalFilter();
        }
        
        function updateZonalFilter() {
            const activePeriodoBtn = document.querySelector('#periodo-filter button.active');
            if (!activePeriodoBtn) return;
            const selectedPeriodo = parseInt(activePeriodoBtn.dataset.periodo);
            
            const periodData = fullData.filter(item => item.periodo === selectedPeriodo);
            const zonales = ['Todos los Zonales', ...new Set(periodData.map(item => item.zonal))].sort();
            
            const zonalFilter = document.getElementById('zonal-filter');
            zonalFilter.innerHTML = zonales.map(z => `<option value="${z}">${z}</option>`).join('');
            
            updateCampusFilter();
        }


        function updateCampusFilter() {
            const selectedZonal = document.getElementById('zonal-filter').value;
            const campusFilter = document.getElementById('campus-filter');
            const activePeriodoBtn = document.querySelector('#periodo-filter button.active');
            if (!activePeriodoBtn) return;
            const selectedPeriodo = parseInt(activePeriodoBtn.dataset.periodo);
            
            let dataForCampusFilter = fullData.filter(item => item.periodo === selectedPeriodo);
            
            if (selectedZonal !== 'Todos los Zonales') {
                dataForCampusFilter = dataForCampusFilter.filter(item => item.zonal === selectedZonal);
            }
            
            const campusOptions = ['Todos los Campus', ...new Set(dataForCampusFilter.map(item => item.campus))].sort();
            campusFilter.innerHTML = campusOptions.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function updateDashboard() {
            const activePeriodoBtn = document.querySelector('#periodo-filter button.active');
            if (!activePeriodoBtn) return;
            const selectedPeriodo = parseInt(activePeriodoBtn.dataset.periodo);
            const selectedZonal = document.getElementById('zonal-filter').value;
            const selectedCampus = document.getElementById('campus-filter').value;

            const filteredData = fullData.filter(item => {
                const periodoMatch = item.periodo === selectedPeriodo;
                const zonalMatch = selectedZonal === 'Todos los Zonales' || item.zonal === selectedZonal;
                const campusMatch = selectedCampus === 'Todos los Campus' || item.campus === selectedCampus;
                return periodoMatch && zonalMatch && campusMatch;
            });

            const totalParticipantes = filteredData.reduce((sum, item) => sum + item.participantes, 0);
            document.getElementById('total-participantes').textContent = totalParticipantes.toLocaleString('es-ES');
            document.getElementById('total-cursos').textContent = filteredData.length.toLocaleString('es-ES');

            const monthlyData = {};
            const meses = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
            meses.forEach(m => monthlyData[m] = 0);

            filteredData.forEach(item => {
                const dateParts = item.inicio.split('-');
                if(dateParts.length === 3) {
                    const monthIndex = parseInt(dateParts[1], 10) - 1;
                    if (!isNaN(monthIndex) && monthIndex >= 0 && monthIndex < 12) {
                        monthlyData[meses[monthIndex]] += item.participantes;
                    }
                }
            });
            monthlyChart.data.datasets[0].data = Object.values(monthlyData);
            monthlyChart.update();

            const materiaData = filteredData.reduce((acc, item) => {
                acc[item.materia] = (acc[item.materia] || 0) + item.participantes;
                return acc;
            }, {});
            const sortedMateria = Object.entries(materiaData).sort((a,b) => b[1] - a[1]);

            materiaChart.data.labels = sortedMateria.map(item => item[0]);
            materiaChart.data.datasets[0].data = sortedMateria.map(item => item[1]);
            materiaChart.update();
            
            updateMap(filteredData, selectedCampus);
        }
        
        function updateMap(data, selectedCampus) {
            markersLayer.clearLayers();
            
            if (selectedCampus !== 'Todos los Campus' && campusCoordinates[selectedCampus]) {
                const coords = campusCoordinates[selectedCampus];
                map.setView(coords, 13);
                const campusData = data.filter(d => d.campus === selectedCampus);
                const totalParticipantes = campusData.reduce((sum, item) => sum + item.participantes, 0);

                const marker = L.marker(coords).addTo(markersLayer);
                marker.bindPopup(`<b>${selectedCampus}</b><br>${totalParticipantes.toLocaleString('es-ES')} participantes`).openPopup();
            } else {
                map.setView([-9.19, -75.015], 6); // Vista general de Peru
                const zonalParticipants = data.reduce((acc, item) => {
                    if(item.zonal !== 'ZONAL VIRTUAL') {
                        acc[item.zonal] = (acc[item.zonal] || 0) + item.participantes;
                    }
                    return acc;
                }, {});
                
                for(const zonal in zonalParticipants) {
                    if(zonalCoordinates[zonal] && zonalParticipants[zonal] > 0) {
                        const marker = L.marker(zonalCoordinates[zonal]).addTo(markersLayer);
                        marker.bindPopup(`<b>${zonal}</b><br>${zonalParticipants[zonal].toLocaleString('es-ES')} participantes`);
                    }
                }
            }
        }


        function setupCharts() {
            Chart.register(ChartDataLabels);
            Chart.defaults.font.family = "'Inter', sans-serif";

            const monthlyCtx = document.getElementById('monthly-chart').getContext('2d');
            monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"],
                    datasets: [{
                        label: 'Participantes',
                        data: [],
                        backgroundColor: 'rgba(13, 110, 253, 0.7)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });

            const materiaCtx = document.getElementById('materia-chart').getContext('2d');
            materiaChart = new Chart(materiaCtx, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6c757d', '#0dcaf0', '#fd7e14', '#20c997', '#6f42c1'] }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            formatter: (value, ctx) => {
                                if (value === 0) return '';
                                const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = (value / sum * 100).toFixed(1) + '%';
                                return percentage;
                            },
                            color: '#fff',
                            font: { weight: 'bold' }
                        }
                    }
                }
            });
        }
        
        function setupMap() {
            map = L.map('map').setView([-9.19, -75.015], 6); // Centered on Peru
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const btnCis = document.getElementById('btn-cis');
            const btnEnglishScore = document.getElementById('btn-englishscore');
            const cisContent = document.getElementById('cis-content');
            const englishScoreContent = document.getElementById('englishscore-content');

            setupCharts();
            setupMap();
            loadAndProcessData();
            if (fullData.length > 0) {
                populateFilters();
                updateDashboard();
            }

            btnCis.addEventListener('click', () => {
                btnCis.classList.add('active');
                btnEnglishScore.classList.remove('active');
                cisContent.classList.remove('hidden');
                englishScoreContent.classList.add('hidden');
                // Re-validate map size after it becomes visible
                setTimeout(() => map.invalidateSize(), 10);
            });

            btnEnglishScore.addEventListener('click', () => {
                btnEnglishScore.classList.add('active');
                btnCis.classList.remove('active');
                englishScoreContent.classList.remove('hidden');
                cisContent.classList.add('hidden');
            });


            document.getElementById('periodo-filter').addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#periodo-filter button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateZonalFilter();
                    updateDashboard();
                }
            });
            document.getElementById('zonal-filter').addEventListener('change', () => {
                updateCampusFilter();
                updateDashboard();
            });
            document.getElementById('campus-filter').addEventListener('change', updateDashboard);
        });
    </script>
</body>
</html>

